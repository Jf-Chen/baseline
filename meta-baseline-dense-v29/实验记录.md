#### 做法一
```
# ================ 计算support set 自身权重和query到 support set的权重 =====================#
# 只有这个bmm作为相似度，让人疑惑
support_inner_matrix = torch.bmm(support_set,support_set.permute(0,2,1)) 
# [way,shot*h*w,shot*h*w]
support_sum = support_inner_matrix.sum(dim=2) #[way,shot*h*w]
support_sum_all = support_sum.sum(dim=1) + 1e-08# [way]
support_sum_all_sq= support_sum_all .unsqueeze(dim=1) #[way,1]
# support_weight = (shot*h*w)*support_sum / support_sum_all_sq #[way,shot*h*w]
support_weight = support_sum / support_sum_all_sq


support_set_proto = (support_weight.unsqueeze(dim=2)).mul( support_set) # [way,shot*h*w,c]
proto_pool = support_set_proto.sum(dim=1)/shot # [way,c]

# 计算query
# 先不算，看看成果
query_pool = query_set.sum(dim=1)
sim = torch.mm(query_pool,proto_pool.permute(1,0)) # [query,way] 
Similarity_list.append(sim)
```

这种做法得到的weight比较小，在0.08左右

结果是

```
set gpu: 0
dataset: torch.Size([3, 80, 80]) (x12000), 20
num params: 12.4M
test epoch 1: acc=61.70 +- 0.73 (%), loss=1.2934 (@7)
set gpu: 0
dataset: torch.Size([3, 80, 80]) (x12000), 20
num params: 12.4M
test epoch 1: acc=72.12 +- 0.60 (%), loss=0.9885 (@7)
```

#### 做法二

```
# ================ 计算support set 自身权重和query到 support set的权重 =====================#
# 只有这个bmm作为相似度，让人疑惑
support_inner_matrix = torch.bmm(support_set,support_set.permute(0,2,1)) 
# [way,shot*h*w,shot*h*w]
support_sum = support_inner_matrix.sum(dim=2) #[way,shot*h*w]
support_sum_all = support_sum.sum(dim=1) + 1e-08# [way]
support_sum_all_sq= support_sum_all .unsqueeze(dim=1) #[way,1]
# support_weight = (shot*h*w)*support_sum / support_sum_all_sq #[way,shot*h*w]


#### 修改这一句
support_weight = (shot*h*w)*support_sum / support_sum_all_sq


support_set_proto = (support_weight.unsqueeze(dim=2)).mul( support_set) # [way,shot*h*w,c]
proto_pool = support_set_proto.sum(dim=1)/shot # [way,c]

# 计算query
# 先不算，看看成果
query_pool = query_set.sum(dim=1)
sim = torch.mm(query_pool,proto_pool.permute(1,0)) # [query,way] 
Similarity_list.append(sim)
```

这样的weight在1左右

结果是

```
set gpu: 0
dataset: torch.Size([3, 80, 80]) (x12000), 20
num params: 12.4M
test epoch 1: acc=52.49 +- 0.73 (%), loss=1.8772 (@7)
set gpu: 0
dataset: torch.Size([3, 80, 80]) (x12000), 20
num params: 12.4M
test epoch 1: acc=67.89 +- 0.62 (%), loss=0.8779 (@7)
```

#### 分析

我认为是调整了support但是没调整query的原因

#### 做法三

只调整query，按照query和support set的相似度调整